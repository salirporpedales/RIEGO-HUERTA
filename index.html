<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Riego Seguro</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root {
            --bg: #f0f2f5;
            --card: #ffffff;
            --primary: #1a73e8;
            --orange: #ff9800;
            --green: #4caf50;
            --gray: #757575;
            --red: #d32f2f;
        }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: var(--card); border-radius: 12px; padding: 25px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); width: 100%; max-width: 420px; box-sizing: border-box; }
        
        /* Estilos de Login */
        .login-header { text-align: center; margin-bottom: 20px; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .btn-login { width: 100%; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px; }

        /* Estilos del Panel (Oculto inicialmente) */
        #admin-panel { display: none; width: 100%; max-width: 500px; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .logout-link { color: var(--red); cursor: pointer; font-size: 0.9rem; font-weight: bold; text-decoration: none; }
        
        .relay-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .btn-action { width: 140px; padding: 10px; border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; background: var(--gray); transition: 0.3s; }
        
        /* Colores de estado */
        .waiting { background-color: var(--orange) !important; }
        .active { background-color: var(--green) !important; box-shadow: 0 0 8px rgba(76,175,80,0.4); }

        .stop-btn { background: var(--red); color: white; width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="auth-section" class="card">
        <div class="login-header">
            <h2> Acceso al Riego</h2>
            <p>Introduce tus credenciales</p>
        </div>
        <input type="email" id="email" placeholder="Correo electr贸nico">
        <input type="password" id="password" placeholder="Contrase帽a">
        <button class="btn-login" onclick="login()">ENTRAR</button>
        <p id="error-msg" style="color: red; text-align: center; font-size: 0.8rem;"></p>
    </div>

    <div id="admin-panel">
        <div class="card">
            <div class="panel-header">
                <strong>Configuraci贸n General</strong>
                <a class="logout-link" onclick="logout()">Cerrar Sesi贸n </a>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>Tiempo de Riego (min):</span>
                <input type="number" id="tiempoInput" style="width: 80px;" onchange="updateTime(this.value)">
            </div>
        </div>

        <div class="card" style="margin-top: 20px;">
            <h3 style="margin-top: 0;">Sectores de Riego</h3>
            <div id="relays-container"></div>
            <button class="stop-btn" onclick="emergencyStop()"> PARADA DE EMERGENCIA</button>
        </div>
    </div>

    <script>
        // --- CONFIGURACIN FIREBASE (Copia tus datos aqu铆) ---
        const firebaseConfig = {
            apiKey: "AIzaSyD2QRDQ-QoxZ8GwgEonC0gQJ6CU6BG-Th4",
            authDomain: "riego-huerta.firebaseapp.com",
            databaseURL: "https://TU_DATABASE_URL.firebaseio.com",
            projectId: "riego-huerta"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // 1. L贸gica de Autenticaci贸n
        function login() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            auth.signInWithEmailAndPassword(email, pass).catch(err => {
                document.getElementById('error-msg').innerText = "Error: " + err.message;
            });
        }

        function logout() {
            auth.signOut();
        }

        // Observador de Sesi贸n
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                iniciarSincronizacion();
            } else {
                document.getElementById('auth-section').style.display = 'block';
                document.getElementById('admin-panel').style.display = 'none';
                detenerSincronizacion();
            }
        });

        // 2. Crear botones de rel茅s
        const container = document.getElementById('relays-container');
        for (let i = 1; i <= 7; i++) {
            container.innerHTML += `
                <div class="relay-item">
                    <span>Sector ${i}</span>
                    <button id="btn${i}" class="btn-action" onclick="activateRelay(${i})">APAGADO</button>
                </div>
            `;
        }

        // 3. Funciones de Control
        function activateRelay(id) {
            const btn = document.getElementById(`btn${id}`);
            btn.classList.add('waiting');
            btn.innerText = "ENVIANDO...";
            db.ref(`/relay${id}`).set(true);
        }

        function updateTime(val) {
            db.ref('/tiempo').set(parseInt(val));
        }

        function emergencyStop() {
            db.ref('/stop').set(true);
            setTimeout(() => db.ref('/stop').set(false), 2000);
        }

        // 4. Sincronizaci贸n en tiempo real
        let listeners = [];
        function iniciarSincronizacion() {
            // Sincronizar Tiempo
            const tRef = db.ref('/tiempo');
            tRef.on('value', s => document.getElementById('tiempoInput').value = s.val() || 0);
            listeners.push(tRef);

            // Sincronizar Botones
            for (let i = 1; i <= 7; i++) {
                const oRef = db.ref(`/orden${i}`);
                oRef.on('value', snap => {
                    const btn = document.getElementById(`btn${i}`);
                    if (snap.val()) {
                        btn.classList.remove('waiting');
                        btn.classList.add('active');
                        btn.innerText = "REGANDO";
                    } else {
                        btn.classList.remove('waiting', 'active');
                        btn.innerText = "APAGADO";
                    }
                });
                listeners.push(oRef);
            }
        }

        function detenerSincronizacion() {
            listeners.forEach(ref => ref.off());
            listeners = [];
        }
    </script>
</body>
</html>
