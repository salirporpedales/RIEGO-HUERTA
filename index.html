
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Riego Pro</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root {
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --primary: #2196F3;
            --waiting: #ff9800; /* Naranja */
            --active: #4CAF50;  /* Verde */
            --off: #757575;     /* Gris */
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-color); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .card { background: var(--card-bg); padding: 25px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); width: 100%; max-width: 450px; margin-bottom: 20px; }
        h2 { margin-top: 0; color: #333; font-size: 1.2rem; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        .relay-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 20px; }
        
        .relay-btn {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; border: none; border-radius: 10px;
            background: var(--off); color: white; font-weight: bold;
            cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }

        /* Clases de estado */
        .btn-waiting { background-color: var(--waiting) !important; transform: translateY(2px); box-shadow: none; }
        .btn-active { background-color: var(--active) !important; }
        
        input[type="number"] { width: 80px; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; }
        .btn-stop { background: #d32f2f; color: white; border: none; padding: 15px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 20px; font-size: 1rem; }
    </style>
</head>
<body>

    <div class="card">
        <h2>‚è±Ô∏è Configuraci√≥n de Tiempo</h2>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span>Duraci√≥n (minutos):</span>
            <input type="number" id="tiempoInput" value="0" onchange="actualizarTiempo(this.value)">
        </div>
    </div>

    <div class="card">
        <h2>üíß Control de V√°lvulas</h2>
        <div class="relay-grid" id="relayContainer"></div>
        <button class="btn-stop" onclick="emergenciaStop()">üõë PARADA TOTAL</button>
    </div>

    <script>
        // CONFIGURACI√ìN DE FIREBASE
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            databaseURL: "TU_URL_DATABASE",
            projectId: "TU_PROJECT_ID"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Generar botones de rel√©
        const container = document.getElementById('relayContainer');
        for (let i = 1; i <= 7; i++) {
            container.innerHTML += `
                <button id="btnRelay${i}" class="relay-btn" onclick="enviarOrden(${i})">
                    <span>V√°lvula ${i}</span>
                    <span id="label${i}">APAGADO</span>
                </button>
            `;
        }

        // --- L√ìGICA DE CONTROL ---

        function enviarOrden(id) {
            const btn = document.getElementById(`btnRelay${id}`);
            // 1. Efecto inmediato: Naranja (Enviando...)
            btn.classList.add('btn-waiting');
            document.getElementById(`label${id}`).innerText = "ENVIANDO...";
            
            // 2. Escribir en Firebase el trigger
            db.ref('/relay' + id).set(true);
        }

        function actualizarTiempo(val) {
            db.ref('/tiempo').set(parseInt(val));
        }

        function emergenciaStop() {
            db.ref('/stop').set(true);
            setTimeout(() => db.ref('/stop').set(false), 2000);
        }

        // --- ESCUCHA DE ESTADOS (Sincronizaci√≥n) ---

        for (let i = 1; i <= 7; i++) {
            // Escuchar el nodo /ordenX que maneja el NodeMCU
            db.ref('/orden' + i).on('value', (snap) => {
                const activo = snap.val();
                const btn = document.getElementById(`btnRelay${i}`);
                const label = document.getElementById(`label${i}`);

                if (activo) {
                    // 3. Si el hardware confirma (verde)
                    btn.classList.remove('btn-waiting');
                    btn.classList.add('btn-active');
                    label.innerText = "REGANDO";
                } else {
                    // 4. Si el hardware apaga (gris)
                    btn.classList.remove('btn-waiting', 'btn-active');
                    label.innerText = "APAGADO";
                }
            });

            // Sincronizar si alguien apaga el trigger manualmente o por tiempo
            db.ref('/relay' + i).on('value', (snap) => {
                if(snap.val() === false) {
                    // Si el trigger es false, nos aseguramos de quitar el naranja
                    document.getElementById(`btnRelay${i}`).classList.remove('btn-waiting');
                }
            });
        }

        // Sincronizar campo de tiempo
        db.ref('/tiempo').on('value', snap => {
            document.getElementById('tiempoInput').value = snap.val() || 0;
        });
    </script>
</body>
</html>
